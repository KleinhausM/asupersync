name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      baseline_ref:
        description: 'Git ref to use as baseline (default: main)'
        required: false
        default: 'main'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUST_TOOLCHAIN: nightly-2026-02-05
  # Reduce benchmark noise
  CARGO_INCREMENTAL: 0

# Cancel in-progress runs for the same PR
concurrency:
  group: benchmarks-${{ github.ref }}
  cancel-in-progress: true

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      # Run current benchmarks
      - name: Run benchmarks (current)
        run: |
          cargo bench --all-features -- --noplot --save-baseline current

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: target/criterion/
          retention-days: 30

  # Regression detection for PRs
  regression-check:
    name: Regression Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-regression-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-

      # Run baseline benchmarks from main
      - name: Checkout base branch
        run: git checkout ${{ github.base_ref }}

      - name: Run baseline benchmarks
        run: |
          cargo bench --all-features -- --noplot

      # Switch back and compare
      - name: Checkout PR branch
        run: git checkout ${{ github.head_ref }}

      - name: Capture baseline (using PR script)
        run: |
          ./scripts/capture_baseline.sh --save /tmp/bench_baseline

      - name: Run PR benchmarks
        run: |
          cargo bench --all-features -- --noplot
          ./scripts/capture_baseline.sh --save /tmp/bench_current

      - name: Compare benchmarks against baseline
        run: |
          python3 - <<'PY'
          import json
          import math
          import os
          import sys

          baseline_path = "/tmp/bench_baseline/baseline_latest.json"
          current_path = "/tmp/bench_current/baseline_latest.json"

          with open(baseline_path, "r") as fh:
              baseline = json.load(fh)
          with open(current_path, "r") as fh:
              current = json.load(fh)

          base_map = {b["name"]: b for b in baseline.get("benchmarks", [])}
          cur_map = {b["name"]: b for b in current.get("benchmarks", [])}

          thresholds = {
              "mean_ns": 1.10,
              "p95_ns": 1.15,
              "p99_ns": 1.25,
          }

          results = []
          failures = []
          missing_current = []

          for name, base in base_map.items():
              cur = cur_map.get(name)
              if cur is None:
                  missing_current.append(name)
                  results.append({"name": name, "status": "missing_current"})
                  continue

              entry = {"name": name, "status": "ok", "metrics": {}}
              for metric, threshold in thresholds.items():
                  base_v = base.get(metric)
                  cur_v = cur.get(metric)
                  if base_v is None or cur_v is None:
                      entry["metrics"][metric] = {"status": "missing"}
                      continue

                  if base_v == 0:
                      ratio = float("inf") if cur_v > 0 else 1.0
                  else:
                      ratio = cur_v / base_v

                  passed = ratio <= threshold
                  entry["metrics"][metric] = {
                      "baseline": base_v,
                      "current": cur_v,
                      "ratio": ratio,
                      "threshold": threshold,
                      "passed": passed,
                  }
                  if not passed:
                      entry["status"] = "failed"

              if entry["status"] == "failed":
                  failures.append(entry)
              results.append(entry)

          extras = [name for name in cur_map.keys() if name not in base_map]
          summary = {
              "failures": len(failures),
              "missing_current": missing_current,
              "extra_current": extras,
          }

          with open("/tmp/bench_compare.json", "w") as fh:
              json.dump({"summary": summary, "results": results}, fh, indent=2)

          if failures:
              print("Performance regressions detected:")
              for f in failures[:10]:
                  print(f"  - {f['name']}")
              sys.exit(1)

          if missing_current:
              print(f"Warning: {len(missing_current)} benchmarks missing in current run")
          if extras:
              print(f"Note: {len(extras)} new benchmarks in current run")
          print("No threshold regressions detected")
          PY

      - name: Upload comparison results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-comparison-${{ github.sha }}
          path: |
            /tmp/bench_baseline/
            /tmp/bench_current/
            /tmp/bench_compare.json
            target/criterion/
          retention-days: 30

  # Scheduler-specific benchmarks with thresholds
  scheduler-perf:
    name: Scheduler Performance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-scheduler-${{ hashFiles('**/Cargo.lock') }}

      - name: Run scheduler benchmarks
        run: |
          cargo bench --all-features --bench scheduler_benchmark -- --noplot 2>&1 | tee scheduler-bench.txt

      - name: Check performance thresholds
        run: |
          # Parse benchmark results and check against thresholds
          # LocalQueue push/pop should be < 100ns
          # GlobalQueue push/pop should be < 200ns
          # PriorityScheduler schedule/pop should be < 500ns

          echo "Scheduler benchmark results:"
          cat scheduler-bench.txt

          # Basic check - if benchmarks completed, we're good
          if grep -q "scheduler" scheduler-bench.txt; then
            echo "Scheduler benchmarks completed successfully"
          else
            echo "::warning::Scheduler benchmarks may not have run correctly"
          fi

      - name: Upload scheduler results
        uses: actions/upload-artifact@v4
        with:
          name: scheduler-benchmark-${{ github.sha }}
          path: scheduler-bench.txt
          retention-days: 30

  # Protocol benchmarks
  protocol-perf:
    name: Protocol Performance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-bench-protocol-${{ hashFiles('**/Cargo.lock') }}

      - name: Run protocol benchmarks
        run: |
          cargo bench --all-fe
